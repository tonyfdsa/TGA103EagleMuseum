<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <!-- /teleplete -->
    <link rel="stylesheet" href="./CSS/templete.css" />
    <!-- bookstrapt -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
      crossorigin="anonymous"
    />
     <style>
      .delBtn:hover{
        color: rgba(245, 28, 28, 0.701);
      }

      .buy{
        height: 100%;
        font-size: 14px;
        width: 100px;
        background-color: rgba(247, 110, 60, 0.705);
        color: white;
        cursor: pointer; 
      }
      .buy:hover{
        color: white;
        background-color: rgb(247, 110, 60); 
        font-size: 14px;
      }
     </style>
  </head>


  <body>
    <!-- head -->
    <div class="wrap">
          <div class="row d-flex" >
            <div class="col-1"  alt="大頭貼" ><img src="./img/eagleIcon.jpg" class="min_picture"></IMG>
              <span id="memberName"></span></div>
            <div class="col-5">
              <h1 style="text-align: center;">Eagle Museum</h1>
            </div>
            <div class="col-6 row d-flex menu btn-group" id="meau">
                <ul class="drop-down-menu d-flex" style="justify-content: end;">
                    <li ><a href="#" class="topTag">首頁</a></li>
                    <li ><a href="exhibition.html" class="topTag">展覽</a></li>
                    <li ><a href="collectionSearch 3.0.html" class="topTag">館藏</a>
                      <ul>
                        <li class="dropMeau"><a href="collectionSearch 3.0.html">館藏資訊</a></li>
                        <li class="dropMeau"><a href="#">館藏地圖</a></li>
                      </ul>
                    </li>
                    <li ><a href="#"  class="topTag">活動</a></li>
                    <li ><a href="#"  class="topTag">商城</a>
                      <ul>
                        <li class="dropMeau"><a href="#">商品列表</a></li>
                        <li class="dropMeau"><a href="#">我的購物車</a></li>
                        <li class="dropMeau"><a href="./buyerCheck.html">訂單查詢</a></li>
                        <li class="dropMeau"><a href="#">最愛清單</a></li>
                      </ul>
                    </li>
                    <li ><a href="#"  class="topTag">會員中心</a>
                      <ul>
                        <li class="dropMeau"><a href="./memberboot.html" >會員資料</a></li>
                        <li class="dropMeau"><a href="#">訂單資料</a></li>
                        <li class="dropMeau"><a href="#">我的收藏</a></li>
                      </ul>
                    </li>
                    <li ><a href="./contactUs(bootstrap).html" class="topTag">聯絡我們</a>
                      <ul>
                          <li class="dropMeau"><a href="./trafic.html">交通資訊</a></li>
                          <li class="dropMeau"><a href="./memberJoin1.html">合作提案</a></li>
                          <li class="dropMeau"><a href="#">捐款</a></li>
                          <li class="dropMeau"><a href="#">問題回饋</a></li>
                          <li class="dropMeau"><a href="#">租借場地</a></li>
                      </ul>
                    </li>
                  </ul>
          </div>
        </div>
    </div>



     
        <div class="upperColumn" id="topcontent" >
        </div>
          
        <!-- </div> -->
       
       <!-- main -->
       <div class="main" style="min-height: 600px;">
        <div style="height: 30px;"></div>
         <div class="container-fluid prod">

          <div class="row">
            <div class="col-1"></div>
            <div class="col-10 ">
              <div style="height: 50px; background-color: rgba(215, 214, 214, 0.39)" class="row">
                <div class="col-2" class="img">
                 
                </div>
                <div class="col-2 d-flex"  style="align-items: center; justify-content: center;">
                  <div style="font-size: 16px;">商品名稱</div>
                </div>
                <div class="col-2 d-flex" style="align-items: center;justify-content: center;">
                  <div style="font-size: 16px;">商品價格</div>
                </div>
                <div class="col-2 d-flex" style="align-items: center;justify-content: center;">
                  <div class="d-flex" align-items: center;>
                    <div style="font-size: 16px;">數量</div>
                  </div>
                </div>
                <div class="col-2 d-flex" style="align-items: center;justify-content: center;">
                  <div style="font-size: 16px;">總價</div>
                </div>

                <div class="col-1 d-flex" style="align-items: center;justify-content: center;">
                  <div class="d-flex" align-items: center;>
                    <div style="font-size: 16px;">操作</div>
                  </div>
                </div>
                
              </div>
            </div>
            <div class="col-1"></div>
          </div>
        



         </div>

         <div class="container-fluid">
          <div class="row" style="margin-top: 10px;">
            <div class="col-1"></div>
            <div class="col-10 " >
              <div style="height: 50px; background-color: rgba(215, 214, 214, 0.39)" class="row">
                <div class="col-8"></div>
                <div class="col-4 d-flex"  style="align-items: center; justify-content: end; padding: 0;">
                  總金額:NTD
                  <input class="totalPrice" style="margin-left: 10px; background-color:transparent" type="text" readonly="readonly" vlaue="">
                  <button class="buy">去買單</button>
                </div>
              </div> 
            </div>
            <div class="col-1"></div>
          </div>
         </div>

         <div style="height: 20px;"></div>
        
       </div>


       <!-- footer -->
       <div class="footer"></div>

  <!-- jQuery 位置 -->
  <script src="./vendor/js/jquery3.6.0.js"></script>
  <!-- 模板js匯入 位置 -->
  <script src="./JS/Template .js"></script>

  <script >
  
  
  

  //進入頁面立刻取得Session購物資訊
  fetch('/TGA103eagleMuseum/CartGet')
  .then(resp => resp.json())
  .then(Data => {
    console.log(Data)

    for(let i = 0 ; i < Data.result.length; i++){

      text = `
      <div class="row" style="margin-top: 5px">
       <div class="col-1"></div>
       <div class="col-10 pr">
         <div style="height: 150px; background-color: rgba(215, 214, 214, 0.39);" class="row">
           <div class="col-2" class="img" style="height: 100%; padding: 0px;">
             <img src=${Data.result[i].prodImg} style="width: 100%;">
           </div>
           <div class="col-2 d-flex"  style="align-items: center; justify-content: center;">
             <div style="font-size: 20px;">${Data.result[i].prodName}</div>
           </div>
           <div class="col-2 d-flex" style="align-items: center;justify-content: center;">
             <input  class="price" readonly="readonly" value =${Data.result[i].prodPrice} style="font-size: 16px; height: 40px; border: 0px solid; width: 50px; background-color:transparent;">
           </div>
           <div class="col-2 d-flex" style="align-items: center;justify-content: center;">
             <div class="d-flex" align-items: center;>
               <input type="number" min="1" class="count" value=${Data.result[i].prodCount} style="font-size: 16px; height: 40px; border: 1px solid rgba(199, 196, 196, 0.982);; width: 50px; background-color: rgba(255, 251, 251, 0.33);">
             </div>
           </div>
           <div class="col-2 d-flex" style="align-items: center;justify-content: center;">
             <input class="total" readonly="readonly" value=${Data.result[i].prodCount * Data.result[i].prodPrice} style="font-size: 16px; height: 40px; border: 0px solid; width: 50px; background-color:transparent;">
           </div>

           <div class="col-1 d-flex" style="align-items: center;justify-content: center;">
             <div class = "d-flex" style="align-items: center;justify-content: center;">
               <button class="delBtn" type="button" style="background-color:rgba(236, 228, 228, 0.426) ;" data-id= ${Data.result[i].productID}> 刪除商品</button>
             </div>
           </div>

         </div>
       </div>
       <div class="col-1"></div>
     </div>
 </div>
      `
       $(".prod").append(text);
    }
    totalprice()
   })

   


     // console.log(price)
    //單品總數改變時改變總價
    $(document).on("blur",".count",function(){
     let prodCount = $(this).closest(".col-10").find(".count").val();
     let price = $(this).closest(".col-10").find(".price").val();
     let productID = $(this).closest(".col-10").find(".delBtn").attr("data-id");
     $(this).closest(".col-10").find(".total").attr("value",price*prodCount)


     
     //更新session購物車數量
     fetch('/TGA103eagleMuseum/CartUpdate', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({
                   productID,
                   prodCount
                 })
               })
               .then(resp => resp.json())
               .then(Data => {
                 // console.log(Data)
                 $(this).closest(".col-10").find(".total").attr("value",price*prodCount)
                 totalprice()
               })
    })



    //點擊刪除按鈕刪除購物車欄位和session del
      $(document).on("click",".delBtn",function(){
       // $(this).closest(".row").remove();
       let productID = $(this).attr("data-id");

       //傳去session刪除
       fetch('/TGA103eagleMuseum/CartDel', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({
                   productID 
                 })
               })
               .then(resp => resp.json())
               .then(Data => {
                 if (Data.message === "Success"){
                   $(this).closest(".row").remove();
                   totalprice()
                 }
               })

      }) 
      //點擊結帳轉跳
      document.querySelector(".buy").addEventListener("click",function(){
       // console.log($(".price").length)
       // console.log($(".totalPrice").attr("value"))

       
       if($(".price").length === 0  ){
         alert("請新增商品至購物車")
       }else{
         location.href = "../order/toBeFiltered/OrderCheckOut.html";        
       }
       
      })

      //點擊圖片跳轉到商品頁面
      $(document).click(".card",function(){
       let prodID = $(this).attr("id")
       console.log(prodID)
       sessionStorage.setItem("prodID", prodID)
       
      })



     //計算總金額用方法
     function  totalprice(){
       let totalprice = 0
       for(let i=0; i< $(".total").length;i++){
         totalprice = Number(totalprice) + Number($(".pr").find(".total")[i].value);
         }
         $(".totalPrice").attr("value",totalprice)
     }

     

   

  </script>
</html>
